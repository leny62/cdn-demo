<!DOCTYPE html>
<html>
  <head>
    <title>Marketing Landing Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        color: #333;
        text-align: center;
      }

      .button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
      }

      .form-container {
        margin-top: 20px;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
      }

      .form-container input[type="text"],
      .form-container input[type="email"],
      .form-container input[type="submit"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
    </style>

    <script>
      class hikr {
        constructor() {
          this.profileHistoryId = localStorage.getItem("history") || undefined;
        }

        static saveToLocalStorage(data) {
          for (const key in data) {
            if (data.hasOwnProperty(key)) {
              localStorage.setItem(key, data[key]);
            }
          }
        }

        static async config({ websiteId }) {
          const user = this.readCookie("bp_user");
          if (!user) {
            await this.createUser(websiteId);
          } else {
            this.setupEventListeners(websiteId);
          }
        }

        static createCookie(cookieName, cookieValue) {
          try {
            return (document.cookie = `${cookieName}=${cookieValue}; expires=${this.getCookieExpirationDate()}; path=/`);
          } catch (error) {
            console.error(error);
          }
        }

        static readCookie(cookieName) {
          const name = `${cookieName}=`;
          const decodedCookie = decodeURIComponent(document.cookie);
          const cookieArray = decodedCookie.split(";");

          for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i];

            while (cookie.charAt(0) === " ") {
              cookie = cookie.substring(1);
            }

            if (cookie.indexOf(name) === 0) {
              const result = cookie.substring(name.length, cookie.length);

              this.createCookie(cookieName, result);

              return result;
            }
          }

          return "";
        }

        static async apiCall(endpoint, payload, method = "POST") {
          const BASE_URL = `https://api.bouletteproof.com/api/cdn/v1/${endpoint}`;

          return fetch(BASE_URL, {
            method,
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .catch((error) => {
              throw error;
            });
        }

        static getQueryParam(param) {
          const queryString = window.location.search;
          if (queryString) {
            const params = new URLSearchParams(queryString);
            return params.get(param);
          }
          return null;
        }

        static async getPublicIpAddress() {
          try {
            const response = await fetch("https://api.ipify.org/?format=json");
            const data = await response.json();
            return data.ip;
          } catch (error) {
            console.error("Error getting public IP address:", error);
            return null;
          }
        }

        static async createUser(websiteId) {
          if (websiteId === undefined) {
            throw new Error("Website ID is required");
          }

          const userIpAddress = await this.getPublicIpAddress();

          if (!userIpAddress) {
            console.error("Unable to retrieve user's IP address");
            return;
          }

          const payload = {
            source: this.getQueryParam("utm_source"),
            medium: this.getQueryParam("utm_medium") || null,
            websiteId: websiteId,
            campaignUrl: this.getQueryParam("utm_campaign") || null,
            ipAddress: userIpAddress,
          };

          try {
            const userData = await this.apiCall("profile", payload);
            this.createCookie("bp_user", userData.userId);
            const user = this.readCookie("bp_user");
            const userHistory = {
              userProfileId: user,
              pageUrl: window.location.href,
              pageTitle: document.title,
              websiteId: websiteId,
              ipAddress: userIpAddress,
            };
            try {
              const userprofileHistory = await this.apiCall(
                "profile/history",
                userHistory
              );
              this.profileHistoryId =
                userprofileHistory?.userProfileHistory?.id;
              this.saveToLocalStorage({
                history: this.profileHistoryId,
              });
            } catch (error) {
              console.error("Error submitting user history:", error);
            }
          } catch (error) {
            console.error("Error creating user:", error);
          }
        }

        static getCookieExpirationDate() {
          const expirationDate = new Date();
          expirationDate.setDate(expirationDate.getDate() + 30);
          return expirationDate.toUTCString();
        }

        static async onPageLoadOrURLChange(websiteId) {
          const user = this.readCookie("bp_user");
          const userHistory = {
            userProfileId: user,
            pageUrl: window.location.href,
            pageTitle: document.title,
            websiteId: websiteId,
          };

          try {
            const userprofileHistory = await this.apiCall(
              "profile/history",
              userHistory
            );
            this.profileHistoryId = userprofileHistory?.userProfileHistory?.id;
            this.saveToLocalStorage({
              history: this.profileHistoryId,
            });
          } catch (error) {
            console.error("Error submitting user history:", error);
          }
        }

        static setupEventListeners(websiteId) {
          let previousUrl = "";
          const observer = new MutationObserver((mutations) => {
            if (location.href !== previousUrl) {
              previousUrl = location.href;
              this.onPageLoadOrURLChange(websiteId);
            }
          });
          const config = { subtree: true, childList: true };
          observer.observe(document, config);
        }

        static async pushData({ eventType, collectionName, data }) {
          const user = this.readCookie("bp_user");

          const eventData = {
            timestamp: new Date().toISOString(),
            historyId: localStorage.getItem("history") || undefined,
            event: eventType,
            data: data,
          };

          if (eventType === "form_submission") {
            const form = document.querySelector("form");
            if (form) {
              const formData = new FormData(form);
              const formInputs = Array.from(formData.entries());
              eventData.data = JSON.stringify(formInputs);
            }
          }

          try {
            await this.apiCall("action", eventData, "POST");
          } catch (error) {
            console.error(`Error ${eventType} updating history:`, error);
          }
        }
      }
    </script>

    <script>
      hikr.config({
        websiteId: "4996094772",
      });
    </script>
  </head>

  <body>
    <nav>
      <a href="index.html">Back to Home</a>
    </nav>

    <div class="container">
      <h1>Welcome to our Marketing Landing Page!</h1>

      <div>
        <a href="#" class="button" onclick="createEvent('button1')">Button 1</a>
        <a href="#" class="button" onclick="createEvent('button2')">Button 2</a>
        <a href="#" class="button" onclick="createEvent('button3')">Button 3</a>
      </div>

      <div class="form-container">
        <h2>Get in touch</h2>
        <form action="https://localhost:4000/api/cdn/{endpoint}" method="POST">
          <input type="text" name="name" placeholder="Your Name" required />
          <input type="email" name="email" placeholder="Your Email" required />
          <button value="Submit" id="formSubmit">FormSubmit</button>
        </form>
        <button value="Submit" id="submit">Submit</button>
      </div>
    </div>
    <script>
      function createEvent(buttonName) {
        // Code to create events goes here
        console.log("Event created for " + buttonName);
        // Push data when a button is clicked
        hikr.pushData({
          eventType: "button_click",
          collectionName: "ButtonEvents",
          data: buttonName,
        });
      }
    </script>
  </body>
</html>
