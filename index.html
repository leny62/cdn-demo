<!DOCTYPE html>
<html>
  <head>
    <title>Test CDN</title>
    <meta charset="UTF-8" />
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" /> -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      class hikr {
        constructor() {
          this.profileHistoryId = localStorage.getItem("history") || undefined;
        }

        static saveToLocalStorage(data) {
          for (const key in data) {
            if (data.hasOwnProperty(key)) {
              localStorage.setItem(key, data[key]);
            }
          }
        }

        static async config({ websiteId }) {
          const user = this.readCookie("bp_user");
          if (!user) {
            await this.createUser(websiteId);
          } else {
            this.setupEventListeners(websiteId);
          }
        }

        static createCookie(cookieName, cookieValue) {
          try {
            return (document.cookie = `${cookieName}=${cookieValue}; expires=${this.getCookieExpirationDate()}; path=/`);
          } catch (error) {
            console.error(error);
          }
        }

        static readCookie(cookieName) {
          const name = `${cookieName}=`;
          const decodedCookie = decodeURIComponent(document.cookie);
          const cookieArray = decodedCookie.split(";");

          for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i];

            while (cookie.charAt(0) === " ") {
              cookie = cookie.substring(1);
            }

            if (cookie.indexOf(name) === 0) {
              const result = cookie.substring(name.length, cookie.length);

              this.createCookie(cookieName, result);

              return result;
            }
          }

          return "";
        }

        static async apiCall(endpoint, payload, method = "POST") {
          const BASE_URL = `https://api.bouletteproof.com/api/cdn/v1/${endpoint}`;

          return fetch(BASE_URL, {
            method,
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .catch((error) => {
              throw error;
            });
        }

        static getQueryParam(param) {
          const queryString = window.location.search;
          if (queryString) {
            const params = new URLSearchParams(queryString);
            return params.get(param);
          }
          return null;
        }

        static async getPublicIpAddress() {
          try {
            const response = await fetch("https://api.ipify.org/?format=json");
            const data = await response.json();
            return data.ip;
          } catch (error) {
            console.error("Error getting public IP address:", error);
            return null;
          }
        }

        static async createUser(websiteId) {
          if (websiteId === undefined) {
            throw new Error("Website ID is required");
          }

          const userIpAddress = await this.getPublicIpAddress();

          if (!userIpAddress) {
            console.error("Unable to retrieve user's IP address");
            return;
          }

          const payload = {
            source: this.getQueryParam("utm_source"),
            medium: this.getQueryParam("utm_medium") || null,
            websiteId: websiteId,
            campaignUrl: this.getQueryParam("utm_campaign") || null,
            ipAddress: userIpAddress,
          };

          try {
            const userData = await this.apiCall("profile", payload);
            this.createCookie("bp_user", userData.userId);
            const user = this.readCookie("bp_user");
            const userHistory = {
              userProfileId: user,
              pageUrl: window.location.href,
              pageTitle: document.title,
              websiteId: websiteId,
              ipAddress: userIpAddress,
            };
            try {
              const userprofileHistory = await this.apiCall(
                "profile/history",
                userHistory
              );
              this.profileHistoryId =
                userprofileHistory?.userProfileHistory?.id;
              this.saveToLocalStorage({
                history: this.profileHistoryId,
              });
            } catch (error) {
              console.error("Error submitting user history:", error);
            }
          } catch (error) {
            console.error("Error creating user:", error);
          }
        }

        static getCookieExpirationDate() {
          const expirationDate = new Date();
          expirationDate.setDate(expirationDate.getDate() + 30);
          return expirationDate.toUTCString();
        }

        static async onPageLoadOrURLChange(websiteId) {
          const user = this.readCookie("bp_user");
          const userHistory = {
            userProfileId: user,
            pageUrl: window.location.href,
            pageTitle: document.title,
            websiteId: websiteId,
          };

          try {
            const userprofileHistory = await this.apiCall(
              "profile/history",
              userHistory
            );
            this.profileHistoryId = userprofileHistory?.userProfileHistory?.id;
            this.saveToLocalStorage({
              history: this.profileHistoryId,
            });
          } catch (error) {
            console.error("Error submitting user history:", error);
          }
        }

        static setupEventListeners(websiteId) {
          let previousUrl = "";
          const observer = new MutationObserver((mutations) => {
            if (location.href !== previousUrl) {
              previousUrl = location.href;
              this.onPageLoadOrURLChange(websiteId);
            }
          });
          const config = { subtree: true, childList: true };
          observer.observe(document, config);
        }

        static async pushData({ eventType, collectionName, data }) {
          const user = this.readCookie("bp_user");

          const eventData = {
            timestamp: new Date().toISOString(),
            historyId: localStorage.getItem("history") || undefined,
            event: eventType,
            data: data,
          };

          if (eventType === "form_submission") {
            const form = document.querySelector("form");
            if (form) {
              const formData = new FormData(form);
              const formInputs = Array.from(formData.entries());
              eventData.data = JSON.stringify(formInputs);
            }
          }

          try {
            await this.apiCall("action", eventData, "POST");
          } catch (error) {
            console.error(`Error ${eventType} updating history:`, error);
          }
        }
      }
    </script>
  </head>

  <body class="">
    <div
      class="flex h-screen w-screen justify-center items-center bg-blue-200 flex-col"
    >
      <h1 class="text-3xl font-bold">CDN Demo</h1>
      <!-- Contents -->
      <div class="text-[100px]">ðŸ˜Ž</div>
      <a href="second.html">Second Page</a>
    </div>

    <script>
      hikr.config({
        websiteId: "4996094772",
      });
    </script>
  </body>
</html>
